<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE jasperReport PUBLIC "-//JasperReports//DTD Report Design//EN"
    "http://jasperreports.sourceforge.net/dtds/jasperreport.dtd">

<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports
    http://jasperreports.sourceforge.net/xsd/jasperreport.xsd"
    name="CustomerPurchaseHistory"
    pageWidth="595" pageHeight="842"
    columnWidth="535" leftMargin="30" rightMargin="30"
    topMargin="30" bottomMargin="30">

    <parameter name="From_Date" class="java.lang.String"/>
    <parameter name="To_Date"   class="java.lang.String"/>

    <queryString>
        <![CDATA[
        SELECT
            c.name          AS customer_name,
            c.contact,
            COUNT(s.sale_id)    AS total_purchases,
            SUM(s.total)        AS total_spent,
            MAX(s.sale_date)    AS last_purchase
        FROM Sales s
        JOIN Customers c ON s.customer_id = c.customer_id
        WHERE s.sale_date BETWEEN $P{From_Date} AND $P{To_Date}
        GROUP BY c.customer_id
        ORDER BY total_spent DESC
        ]]>
    </queryString>

    <field name="customer_name"   class="java.lang.String"/>
    <field name="contact"         class="java.lang.String"/>
    <field name="total_purchases" class="java.lang.Long"/>
    <field name="total_spent"     class="java.math.BigDecimal"/>
    <field name="last_purchase"   class="java.lang.String"/>

    <variable name="GRAND_TOTAL" class="java.math.BigDecimal" calculation="Sum">
        <variableExpression><![CDATA[$F{total_spent}]]></variableExpression>
    </variable>

    <title>
        <band height="70">
            <staticText>
                <reportElement x="0" y="0" width="535" height="36"/>
                <textElement textAlignment="Center">
                    <font size="20" isBold="true" fontName="SansSerif"/>
                </textElement>
                <text><![CDATA[NexMart â€“ Customer Purchase History]]></text>
            </staticText>
            <textField>
                <reportElement x="0" y="38" width="535" height="20"/>
                <textElement textAlignment="Center">
                    <font size="11" fontName="SansSerif"/>
                </textElement>
                <textFieldExpression><![CDATA["Period: " + $P{From_Date} + "  to  " + $P{To_Date}]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <columnHeader>
        <band height="26">
            <staticText>
                <reportElement x="0"   y="2" width="130" height="22" backcolor="#107C5A" mode="Opaque"/>
                <textElement><font isBold="true" size="11" fontName="SansSerif"/></textElement>
                <text><![CDATA[Customer]]></text>
            </staticText>
            <staticText>
                <reportElement x="130" y="2" width="100" height="22" backcolor="#107C5A" mode="Opaque"/>
                <textElement><font isBold="true" size="11" fontName="SansSerif"/></textElement>
                <text><![CDATA[Contact]]></text>
            </staticText>
            <staticText>
                <reportElement x="230" y="2" width="85"  height="22" backcolor="#107C5A" mode="Opaque"/>
                <textElement textAlignment="Right"><font isBold="true" size="11" fontName="SansSerif"/></textElement>
                <text><![CDATA[Purchases]]></text>
            </staticText>
            <staticText>
                <reportElement x="315" y="2" width="120" height="22" backcolor="#107C5A" mode="Opaque"/>
                <textElement textAlignment="Right"><font isBold="true" size="11" fontName="SansSerif"/></textElement>
                <text><![CDATA[Total Spent (LKR)]]></text>
            </staticText>
            <staticText>
                <reportElement x="435" y="2" width="100" height="22" backcolor="#107C5A" mode="Opaque"/>
                <textElement textAlignment="Center"><font isBold="true" size="11" fontName="SansSerif"/></textElement>
                <text><![CDATA[Last Purchase]]></text>
            </staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="24">
            <textField>
                <reportElement x="0"   y="2" width="130" height="20"/>
                <textElement><font size="11" fontName="SansSerif"/></textElement>
                <textFieldExpression><![CDATA[$F{customer_name}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="130" y="2" width="100" height="20"/>
                <textElement><font size="11" fontName="SansSerif"/></textElement>
                <textFieldExpression><![CDATA[$F{contact}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="230" y="2" width="85" height="20"/>
                <textElement textAlignment="Right"><font size="11" fontName="SansSerif"/></textElement>
                <textFieldExpression><![CDATA[$F{total_purchases}]]></textFieldExpression>
            </textField>
            <textField pattern="###,##0.00">
                <reportElement x="315" y="2" width="120" height="20"/>
                <textElement textAlignment="Right"><font size="11" fontName="SansSerif"/></textElement>
                <textFieldExpression><![CDATA[$F{total_spent}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="435" y="2" width="100" height="20"/>
                <textElement textAlignment="Center"><font size="11" fontName="SansSerif"/></textElement>
                <textFieldExpression><![CDATA[$F{last_purchase}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <summary>
        <band height="40">
            <line>
                <reportElement x="0" y="4" width="535" height="1"/>
                <graphicElement><pen lineWidth="1.0"/></graphicElement>
            </line>
            <staticText>
                <reportElement x="0" y="10" width="315" height="22"/>
                <textElement><font isBold="true" size="12" fontName="SansSerif"/></textElement>
                <text><![CDATA[Grand Total Spent:]]></text>
            </staticText>
            <textField pattern="###,##0.00">
                <reportElement x="315" y="10" width="120" height="22"/>
                <textElement textAlignment="Right"><font isBold="true" size="12" fontName="SansSerif"/></textElement>
                <textFieldExpression><![CDATA[$V{GRAND_TOTAL}]]></textFieldExpression>
            </textField>
        </band>
    </summary>
</jasperReport>
